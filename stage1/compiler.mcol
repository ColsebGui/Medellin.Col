; Stage 1 compiler with variables - streaming output approach
; Emits ELF header, then parses and emits code directly

parcero is_digit(c: numero) devuelve numero
    si c mayor_igual 48 y c menor_igual 57 entonces
        devuelvase 1
    listo
    devuelvase 0
fin parcero

parcero is_alpha(c: numero) devuelve numero
    si c mayor_igual 65 y c menor_igual 90 entonces
        devuelvase 1
    listo
    si c mayor_igual 97 y c menor_igual 122 entonces
        devuelvase 1
    listo
    si c es_igual 95 entonces
        devuelvase 1
    listo
    devuelvase 0
fin parcero

parcero is_alnum(c: numero) devuelve numero
    si is_alpha(c) es_igual 1 entonces
        devuelvase 1
    listo
    devuelvase is_digit(c)
fin parcero

parcero is_ws(c: numero) devuelve numero
    si c es_igual 32 o c es_igual 9 o c es_igual 10 o c es_igual 13 entonces
        devuelvase 1
    listo
    devuelvase 0
fin parcero

parcero emit(b: numero) devuelve numero
    numero d
    d es escribir_byte(b)
    devuelvase 1
fin parcero

parcero emit_dword(v: numero) devuelve numero
    numero d
    numero t
    t es v
    d es emit(t menos ((t entre 256) por 256))
    t es t entre 256
    d es emit(t menos ((t entre 256) por 256))
    t es t entre 256
    d es emit(t menos ((t entre 256) por 256))
    t es t entre 256
    d es emit(t)
    devuelvase 4
fin parcero

parcero emit_qword(v: numero) devuelve numero
    numero d
    d es emit_dword(v)
    d es emit_dword(0)
    devuelvase 8
fin parcero

parcero emit_elf_header() devuelve numero
    numero d
    numero i
    d es emit(0x7F)
    d es emit(69)
    d es emit(76)
    d es emit(70)
    d es emit(2)
    d es emit(1)
    d es emit(1)
    d es emit(0)
    i es 0
    mientras i es_menor 8 haga
        d es emit(0)
        i es i mas 1
    listo
    d es emit(2)
    d es emit(0)
    d es emit(0x3E)
    d es emit(0)
    d es emit_dword(1)
    d es emit_qword(0x401000)
    d es emit_qword(64)
    d es emit_qword(0)
    d es emit_dword(0)
    d es emit(64)
    d es emit(0)
    d es emit(56)
    d es emit(0)
    d es emit(1)
    d es emit(0)
    d es emit(64)
    d es emit(0)
    d es emit(0)
    d es emit(0)
    d es emit(0)
    d es emit(0)
    d es emit_dword(1)
    d es emit_dword(5)
    d es emit_qword(0x1000)
    d es emit_qword(0x401000)
    d es emit_qword(0x401000)
    d es emit_qword(0x1000)
    d es emit_qword(0x1000)
    d es emit_qword(0x1000)
    i es 0
    mientras i es_menor 3976 haga
        d es emit(0)
        i es i mas 1
    listo
    devuelvase 0
fin parcero

parcero emit_epilogue() devuelve numero
    numero d
    d es emit(0x48)
    d es emit(0x89)
    d es emit(0xEC)
    d es emit(0x5D)
    d es emit(0x48)
    d es emit(0x89)
    d es emit(0xC7)
    d es emit(0xB8)
    d es emit(0x3C)
    d es emit(0x00)
    d es emit(0x00)
    d es emit(0x00)
    d es emit(0x0F)
    d es emit(0x05)
    devuelvase 0
fin parcero

parcero emit_mov_rax_imm(val: numero) devuelve numero
    numero d
    numero v
    d es emit(0x48)
    d es emit(0xB8)
    v es val
    d es emit(v menos ((v entre 256) por 256))
    v es v entre 256
    d es emit(v menos ((v entre 256) por 256))
    v es v entre 256
    d es emit(v menos ((v entre 256) por 256))
    v es v entre 256
    d es emit(v)
    d es emit(0)
    d es emit(0)
    d es emit(0)
    d es emit(0)
    devuelvase 10
fin parcero

parcero emit_mov_rax_rbp_off(off: numero) devuelve numero
    numero d
    d es emit(0x48)
    d es emit(0x8B)
    d es emit(0x45)
    d es emit(off mas 256)
    devuelvase 4
fin parcero

parcero emit_mov_rbp_off_rax(off: numero) devuelve numero
    numero d
    d es emit(0x48)
    d es emit(0x89)
    d es emit(0x45)
    d es emit(off mas 256)
    devuelvase 4
fin parcero

parcero emit_push_rax() devuelve numero
    numero d
    d es emit(0x50)
    devuelvase 1
fin parcero

parcero emit_pop_rbx() devuelve numero
    numero d
    d es emit(0x5B)
    devuelvase 1
fin parcero

; add rax, rbx (result in rax)
parcero emit_add_rax_rbx() devuelve numero
    numero d
    d es emit(0x48)
    d es emit(0x01)
    d es emit(0xD8)
    devuelvase 3
fin parcero

; sub rax, rbx (rax = rax - rbx)
parcero emit_sub_rax_rbx() devuelve numero
    numero d
    d es emit(0x48)
    d es emit(0x29)
    d es emit(0xD8)
    devuelvase 3
fin parcero

; imul rax, rbx (result in rax)
parcero emit_mul_rax_rbx() devuelve numero
    numero d
    d es emit(0x48)
    d es emit(0x0F)
    d es emit(0xAF)
    d es emit(0xC3)
    devuelvase 4
fin parcero

; idiv rbx (rax = rdx:rax / rbx, rdx = remainder)
; Need to sign-extend rax into rdx first with cqo
parcero emit_div_rax_rbx() devuelve numero
    numero d
    ; cqo - sign extend rax to rdx:rax
    d es emit(0x48)
    d es emit(0x99)
    ; idiv rbx
    d es emit(0x48)
    d es emit(0xF7)
    d es emit(0xFB)
    devuelvase 5
fin parcero

; cmp rax, rbx
parcero emit_cmp_rax_rbx() devuelve numero
    numero d
    d es emit(0x48)
    d es emit(0x39)
    d es emit(0xD8)
    devuelvase 3
fin parcero

; sete al (set if equal)
parcero emit_sete_al() devuelve numero
    numero d
    d es emit(0x0F)
    d es emit(0x94)
    d es emit(0xC0)
    devuelvase 3
fin parcero

; setne al (set if not equal)
parcero emit_setne_al() devuelve numero
    numero d
    d es emit(0x0F)
    d es emit(0x95)
    d es emit(0xC0)
    devuelvase 3
fin parcero

; setl al (set if less, signed)
parcero emit_setl_al() devuelve numero
    numero d
    d es emit(0x0F)
    d es emit(0x9C)
    d es emit(0xC0)
    devuelvase 3
fin parcero

; setg al (set if greater, signed)
parcero emit_setg_al() devuelve numero
    numero d
    d es emit(0x0F)
    d es emit(0x9F)
    d es emit(0xC0)
    devuelvase 3
fin parcero

; setle al (set if less or equal, signed)
parcero emit_setle_al() devuelve numero
    numero d
    d es emit(0x0F)
    d es emit(0x9E)
    d es emit(0xC0)
    devuelvase 3
fin parcero

; setge al (set if greater or equal, signed)
parcero emit_setge_al() devuelve numero
    numero d
    d es emit(0x0F)
    d es emit(0x9D)
    d es emit(0xC0)
    devuelvase 3
fin parcero

; movzx rax, al (zero extend al to rax)
parcero emit_movzx_rax_al() devuelve numero
    numero d
    d es emit(0x48)
    d es emit(0x0F)
    d es emit(0xB6)
    d es emit(0xC0)
    devuelvase 4
fin parcero

; test rax, rax (for control flow)
parcero emit_test_rax_rax() devuelve numero
    numero d
    d es emit(0x48)
    d es emit(0x85)
    d es emit(0xC0)
    devuelvase 3
fin parcero

; jz rel8 - short jump if zero (for loops)
parcero emit_jz_rel8(disp: numero) devuelve numero
    numero d
    d es emit(0x74)
    d es emit(disp)
    devuelvase 2
fin parcero

; jmp rel8 - short jump (for loops)
parcero emit_jmp_rel8(disp: numero) devuelve numero
    numero d
    d es emit(0xEB)
    d es emit(disp)
    devuelvase 2
fin parcero

; jnz rel8 - short jump if not zero
parcero emit_jnz_rel8(disp: numero) devuelve numero
    numero d
    d es emit(0x75)
    d es emit(disp)
    devuelvase 2
fin parcero

; emit NOP (0x90)
parcero emit_nop() devuelve numero
    numero d
    d es emit(0x90)
    devuelvase 1
fin parcero

parcero principal() devuelve numero
    arreglo[256] de numero code
    arreglo[16] de numero buf
    arreglo[8] de numero vname
    arreglo[8] de numero voff
    arreglo[8] de numero aname
    arreglo[8] de numero aoff
    arreglo[8] de numero fname
    arreglo[8] de numero foff
    numero fcnt
    numero c
    numero d
    numero len
    numero vcnt
    numero acnt
    numero arr_off
    numero stack_off
    numero h
    numero h2
    numero val
    numero off
    numero i
    numero pos
    numero loop_start
    numero jz_patch
    numero si_jz_patch
    numero si_jmp_patch
    numero ctrl_type

    vcnt es 0
    acnt es 0
    fcnt es 0
    arr_off es 0
    stack_off es 0
    loop_start es 0
    jz_patch es 0
    si_jz_patch es 0
    si_jmp_patch es 0
    ctrl_type es 0
    pos es 0
    d es emit_elf_header()
    ; Emit jmp placeholder to principal (will be backpatched)
    numero jmp_patch_pos
    code[pos] es 0xE9
    pos es pos mas 1
    jmp_patch_pos es pos
    code[pos] es 0
    pos es pos mas 1
    code[pos] es 0
    pos es pos mas 1
    code[pos] es 0
    pos es pos mas 1
    code[pos] es 0
    pos es pos mas 1
    c es leer_byte()

    ; Parse function definitions
    numero in_func
    numero principal_pos
    in_func es 0
    principal_pos es 0
    mientras c es_mayor 0 haga
        mientras is_ws(c) es_igual 1 y c es_mayor 0 haga
            c es leer_byte()
        listo
        si c es_igual 59 entonces
            mientras c es_mayor 0 y (no (c es_igual 10)) haga
                c es leer_byte()
            listo
            c es leer_byte()
        sino
            si is_alpha(c) es_igual 1 entonces
                len es 0
                mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                    buf[len] es c
                    len es len mas 1
                    c es leer_byte()
                listo
                ; parcero = 112,97,114,99,101,114,111 (7 chars)
                si len es_igual 7 y in_func es_igual 0 entonces
                    si buf[0] es_igual 112 y buf[1] es_igual 97 entonces
                        si buf[2] es_igual 114 y buf[3] es_igual 99 entonces
                            si buf[4] es_igual 101 y buf[5] es_igual 114 entonces
                                si buf[6] es_igual 111 entonces
                                    ; Skip whitespace after parcero
                                    mientras is_ws(c) es_igual 1 haga
                                        c es leer_byte()
                                    listo
                                    ; Read function name
                                    len es 0
                                    mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                        buf[len] es c
                                        len es len mas 1
                                        c es leer_byte()
                                    listo
                                    h es buf[0]
                                    fname[fcnt] es h
                                    foff[fcnt] es pos
                                    fcnt es fcnt mas 1
                                    ; Check if this is principal (p=112)
                                    si h es_igual 112 entonces
                                        principal_pos es pos
                                    listo
                                    ; Skip to after devuelve tipo
                                    mientras c es_mayor 0 haga
                                        mientras is_ws(c) es_igual 1 haga
                                            c es leer_byte()
                                        listo
                                        si is_alpha(c) es_igual 1 entonces
                                            len es 0
                                            mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                                buf[len] es c
                                                len es len mas 1
                                                c es leer_byte()
                                            listo
                                            ; devuelve = 100,101,118,117,101,108,118,101
                                            si len es_igual 8 entonces
                                                si buf[0] es_igual 100 y buf[1] es_igual 101 entonces
                                                    si buf[2] es_igual 118 y buf[3] es_igual 117 entonces
                                                        si buf[4] es_igual 101 y buf[5] es_igual 108 entonces
                                                            si buf[6] es_igual 118 y buf[7] es_igual 101 entonces
                                                                mientras is_ws(c) es_igual 1 haga
                                                                    c es leer_byte()
                                                                listo
                                                                mientras is_alnum(c) es_igual 1 haga
                                                                    c es leer_byte()
                                                                listo
                                                                c es 0 menos 1
                                                            listo
                                                        listo
                                                    listo
                                                listo
                                            listo
                                        sino
                                            c es leer_byte()
                                        listo
                                    listo
                                    c es leer_byte()
                                    ; Reset locals for new function
                                    vcnt es 0
                                    acnt es 0
                                    arr_off es 0
                                    stack_off es 0
                                    ; Emit prologue for this function
                                    code[pos] es 0x55
                                    pos es pos mas 1
                                    code[pos] es 0x48
                                    pos es pos mas 1
                                    code[pos] es 0x89
                                    pos es pos mas 1
                                    code[pos] es 0xE5
                                    pos es pos mas 1
                                    code[pos] es 0x48
                                    pos es pos mas 1
                                    code[pos] es 0x81
                                    pos es pos mas 1
                                    code[pos] es 0xEC
                                    pos es pos mas 1
                                    code[pos] es 0x00
                                    pos es pos mas 1
                                    code[pos] es 0x01
                                    pos es pos mas 1
                                    code[pos] es 0x00
                                    pos es pos mas 1
                                    code[pos] es 0x00
                                    pos es pos mas 1
                                    in_func es 1
                                listo
                            listo
                        listo
                    listo
                listo
                si in_func es_igual 1 entonces
                    c es 0 menos 1
                listo
            sino
                c es leer_byte()
            listo
        listo
    listo

    c es leer_byte()

    ; Parse and emit
    mientras c es_mayor 0 haga
        mientras is_ws(c) es_igual 1 y c es_mayor 0 haga
            c es leer_byte()
        listo
        mientras c es_igual 59 haga
            mientras c es_mayor 0 y (no (c es_igual 10)) haga
                c es leer_byte()
            listo
            c es leer_byte()
            mientras is_ws(c) es_igual 1 y c es_mayor 0 haga
                c es leer_byte()
            listo
        listo

        si c menor_igual 0 entonces
            c es 0
        sino
            si is_alpha(c) es_igual 1 entonces
                len es 0
                mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                    buf[len] es c
                    len es len mas 1
                    c es leer_byte()
                listo

                ; fin parcero - emit epilogue
                si len es_igual 3 entonces
                    si buf[0] es_igual 102 y buf[1] es_igual 105 y buf[2] es_igual 110 entonces
                        ; Skip 'parcero' after fin
                        mientras is_ws(c) es_igual 1 haga
                            c es leer_byte()
                        listo
                        mientras is_alnum(c) es_igual 1 haga
                            c es leer_byte()
                        listo
                        ; Check if this function is principal (p=112)
                        si fname[fcnt menos 1] es_igual 112 entonces
                            ; principal: emit epilogue + exit syscall
                            ; mov rsp, rbp (48 89 EC)
                            code[pos] es 0x48
                            pos es pos mas 1
                            code[pos] es 0x89
                            pos es pos mas 1
                            code[pos] es 0xEC
                            pos es pos mas 1
                            ; pop rbp (5D)
                            code[pos] es 0x5D
                            pos es pos mas 1
                            ; mov rdi, rax (48 89 C7)
                            code[pos] es 0x48
                            pos es pos mas 1
                            code[pos] es 0x89
                            pos es pos mas 1
                            code[pos] es 0xC7
                            pos es pos mas 1
                            ; mov eax, 60 (B8 3C 00 00 00)
                            code[pos] es 0xB8
                            pos es pos mas 1
                            code[pos] es 0x3C
                            pos es pos mas 1
                            code[pos] es 0x00
                            pos es pos mas 1
                            code[pos] es 0x00
                            pos es pos mas 1
                            code[pos] es 0x00
                            pos es pos mas 1
                            ; syscall (0F 05)
                            code[pos] es 0x0F
                            pos es pos mas 1
                            code[pos] es 0x05
                            pos es pos mas 1
                        sino
                            ; non-principal: emit epilogue + ret
                            ; mov rsp, rbp (48 89 EC)
                            code[pos] es 0x48
                            pos es pos mas 1
                            code[pos] es 0x89
                            pos es pos mas 1
                            code[pos] es 0xEC
                            pos es pos mas 1
                            ; pop rbp (5D)
                            code[pos] es 0x5D
                            pos es pos mas 1
                            ; ret (C3)
                            code[pos] es 0xC3
                            pos es pos mas 1
                        listo
                        in_func es 0
                    listo
                listo

                ; parcero = 112,97,114,99,101,114,111 (7 chars) - new function
                si len es_igual 7 y in_func es_igual 0 entonces
                    si buf[0] es_igual 112 y buf[1] es_igual 97 entonces
                        si buf[2] es_igual 114 y buf[3] es_igual 99 entonces
                            si buf[4] es_igual 101 y buf[5] es_igual 114 entonces
                                si buf[6] es_igual 111 entonces
                                    ; Skip whitespace after parcero
                                    mientras is_ws(c) es_igual 1 haga
                                        c es leer_byte()
                                    listo
                                    ; Read function name
                                    len es 0
                                    mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                        buf[len] es c
                                        len es len mas 1
                                        c es leer_byte()
                                    listo
                                    h es buf[0]
                                    fname[fcnt] es h
                                    foff[fcnt] es pos
                                    fcnt es fcnt mas 1
                                    ; Check if this is principal (p=112)
                                    si h es_igual 112 entonces
                                        principal_pos es pos
                                    listo
                                    ; Skip to after devuelve tipo
                                    mientras c es_mayor 0 haga
                                        mientras is_ws(c) es_igual 1 haga
                                            c es leer_byte()
                                        listo
                                        si is_alpha(c) es_igual 1 entonces
                                            len es 0
                                            mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                                buf[len] es c
                                                len es len mas 1
                                                c es leer_byte()
                                            listo
                                            ; devuelve = 100,101,118,117,101,108,118,101
                                            si len es_igual 8 entonces
                                                si buf[0] es_igual 100 y buf[1] es_igual 101 entonces
                                                    si buf[2] es_igual 118 y buf[3] es_igual 117 entonces
                                                        si buf[4] es_igual 101 y buf[5] es_igual 108 entonces
                                                            si buf[6] es_igual 118 y buf[7] es_igual 101 entonces
                                                                mientras is_ws(c) es_igual 1 haga
                                                                    c es leer_byte()
                                                                listo
                                                                mientras is_alnum(c) es_igual 1 haga
                                                                    c es leer_byte()
                                                                listo
                                                                c es 0 menos 1
                                                            listo
                                                        listo
                                                    listo
                                                listo
                                            listo
                                        sino
                                            c es leer_byte()
                                        listo
                                    listo
                                    c es leer_byte()
                                    ; Reset locals for new function
                                    vcnt es 0
                                    acnt es 0
                                    arr_off es 0
                                    stack_off es 0
                                    ; Emit prologue for this function
                                    code[pos] es 0x55
                                    pos es pos mas 1
                                    code[pos] es 0x48
                                    pos es pos mas 1
                                    code[pos] es 0x89
                                    pos es pos mas 1
                                    code[pos] es 0xE5
                                    pos es pos mas 1
                                    code[pos] es 0x48
                                    pos es pos mas 1
                                    code[pos] es 0x81
                                    pos es pos mas 1
                                    code[pos] es 0xEC
                                    pos es pos mas 1
                                    code[pos] es 0x00
                                    pos es pos mas 1
                                    code[pos] es 0x01
                                    pos es pos mas 1
                                    code[pos] es 0x00
                                    pos es pos mas 1
                                    code[pos] es 0x00
                                    pos es pos mas 1
                                    in_func es 1
                                listo
                            listo
                        listo
                    listo
                listo

                ; numero
                si len es_igual 6 y c es_mayor 0 entonces
                    si buf[0] es_igual 110 y buf[1] es_igual 117 entonces
                        si buf[2] es_igual 109 y buf[3] es_igual 101 entonces
                            si buf[4] es_igual 114 y buf[5] es_igual 111 entonces
                                mientras is_ws(c) es_igual 1 haga
                                    c es leer_byte()
                                listo
                                len es 0
                                mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                    buf[len] es c
                                    len es len mas 1
                                    c es leer_byte()
                                listo
                                h es buf[0]
                                vname[vcnt] es h
                                stack_off es stack_off menos 8
                                voff[vcnt] es stack_off
                                vcnt es vcnt mas 1
                            listo
                        listo
                    listo
                listo

                ; arreglo = 97,114,114,101,103,108,111 (7 chars)
                si len es_igual 7 y c es_mayor 0 entonces
                    si buf[0] es_igual 97 y buf[1] es_igual 114 entonces
                        si buf[2] es_igual 114 y buf[3] es_igual 101 entonces
                            si buf[4] es_igual 103 y buf[5] es_igual 108 entonces
                                si buf[6] es_igual 111 entonces
                                    mientras is_ws(c) es_igual 1 haga
                                        c es leer_byte()
                                    listo
                                    si c es_igual 91 entonces
                                        c es leer_byte()
                                        numero arr_size
                                        arr_size es 0
                                        mientras is_digit(c) es_igual 1 haga
                                            arr_size es arr_size por 10 mas (c menos 48)
                                            c es leer_byte()
                                        listo
                                        si c es_igual 93 entonces
                                            c es leer_byte()
                                        listo
                                        mientras is_ws(c) es_igual 1 haga
                                            c es leer_byte()
                                        listo
                                        mientras is_alnum(c) es_igual 1 haga
                                            c es leer_byte()
                                        listo
                                        mientras is_ws(c) es_igual 1 haga
                                            c es leer_byte()
                                        listo
                                        mientras is_alnum(c) es_igual 1 haga
                                            c es leer_byte()
                                        listo
                                        mientras is_ws(c) es_igual 1 haga
                                            c es leer_byte()
                                        listo
                                        len es 0
                                        mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                            buf[len] es c
                                            len es len mas 1
                                            c es leer_byte()
                                        listo
                                        h es buf[0]
                                        aname[acnt] es h
                                        stack_off es stack_off menos (arr_size por 8)
                                        aoff[acnt] es stack_off
                                        acnt es acnt mas 1
                                    listo
                                listo
                            listo
                        listo
                    listo
                listo

                ; mientras = 109,105,101,110,116,114,97,115 (8 chars)
                si len es_igual 8 y c es_mayor 0 entonces
                    si buf[0] es_igual 109 y buf[1] es_igual 105 entonces
                        si buf[2] es_igual 101 y buf[3] es_igual 110 entonces
                            si buf[4] es_igual 116 y buf[5] es_igual 114 entonces
                                si buf[6] es_igual 97 y buf[7] es_igual 115 entonces
                                    ; Save loop start position
                                    ctrl_type es 1
                                    loop_start es pos
                                    mientras is_ws(c) es_igual 1 haga
                                        c es leer_byte()
                                    listo
                                    ; Parse condition first operand
                                    si is_digit(c) es_igual 1 entonces
                                        val es 0
                                        mientras is_digit(c) es_igual 1 haga
                                            val es val por 10 mas (c menos 48)
                                            c es leer_byte()
                                        listo
                                        ; mov rax, imm64
                                        numero wt
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0xB8
                                        pos es pos mas 1
                                        wt es val
                                        code[pos] es wt menos ((wt entre 256) por 256)
                                        pos es pos mas 1
                                        wt es wt entre 256
                                        code[pos] es wt menos ((wt entre 256) por 256)
                                        pos es pos mas 1
                                        wt es wt entre 256
                                        code[pos] es wt menos ((wt entre 256) por 256)
                                        pos es pos mas 1
                                        wt es wt entre 256
                                        code[pos] es wt
                                        pos es pos mas 1
                                        code[pos] es 0
                                        pos es pos mas 1
                                        code[pos] es 0
                                        pos es pos mas 1
                                        code[pos] es 0
                                        pos es pos mas 1
                                        code[pos] es 0
                                        pos es pos mas 1
                                    sino
                                        si is_alpha(c) es_igual 1 entonces
                                            numero wh
                                            numero woff
                                            numero wi
                                            len es 0
                                            mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                                buf[len] es c
                                                len es len mas 1
                                                c es leer_byte()
                                            listo
                                            wh es buf[0]
                                            woff es 0
                                            wi es 0
                                            mientras wi es_menor vcnt haga
                                                si vname[wi] es_igual wh entonces
                                                    woff es voff[wi]
                                                listo
                                                wi es wi mas 1
                                            listo
                                            ; mov rax, [rbp+off]
                                            code[pos] es 0x48
                                            pos es pos mas 1
                                            code[pos] es 0x8B
                                            pos es pos mas 1
                                            code[pos] es 0x45
                                            pos es pos mas 1
                                            code[pos] es woff mas 256
                                            pos es pos mas 1
                                        listo
                                    listo
                                    ; Skip whitespace
                                    mientras is_ws(c) es_igual 1 haga
                                        c es leer_byte()
                                    listo
                                    ; Parse comparison operator
                                    si is_alpha(c) es_igual 1 entonces
                                        numero wop
                                        wop es 0
                                        len es 0
                                        mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                            buf[len] es c
                                            len es len mas 1
                                            c es leer_byte()
                                        listo
                                        ; es_igual (8)
                                        si len es_igual 8 y buf[0] es_igual 101 y buf[1] es_igual 115 entonces
                                            si buf[2] es_igual 95 y buf[3] es_igual 105 entonces
                                                si buf[4] es_igual 103 y buf[5] es_igual 117 entonces
                                                    si buf[6] es_igual 97 y buf[7] es_igual 108 entonces
                                                        wop es 5
                                                    listo
                                                listo
                                            listo
                                        listo
                                        ; es_menor (8)
                                        si len es_igual 8 y buf[0] es_igual 101 y buf[1] es_igual 115 entonces
                                            si buf[2] es_igual 95 y buf[3] es_igual 109 entonces
                                                si buf[4] es_igual 101 y buf[5] es_igual 110 entonces
                                                    si buf[6] es_igual 111 y buf[7] es_igual 114 entonces
                                                        wop es 6
                                                    listo
                                                listo
                                            listo
                                        listo
                                        ; es_mayor (8)
                                        si len es_igual 8 y buf[0] es_igual 101 y buf[1] es_igual 115 entonces
                                            si buf[2] es_igual 95 y buf[3] es_igual 109 entonces
                                                si buf[4] es_igual 97 y buf[5] es_igual 121 entonces
                                                    si buf[6] es_igual 111 y buf[7] es_igual 114 entonces
                                                        wop es 7
                                                    listo
                                                listo
                                            listo
                                        listo
                                        ; mayor_igual (11)
                                        si len es_igual 11 y buf[0] es_igual 109 y buf[1] es_igual 97 entonces
                                            si buf[2] es_igual 121 y buf[3] es_igual 111 entonces
                                                si buf[4] es_igual 114 y buf[5] es_igual 95 entonces
                                                    si buf[6] es_igual 105 y buf[7] es_igual 103 entonces
                                                        si buf[8] es_igual 117 y buf[9] es_igual 97 y buf[10] es_igual 108 entonces
                                                            wop es 8
                                                        listo
                                                    listo
                                                listo
                                            listo
                                        listo
                                        ; menor_igual (11)
                                        si len es_igual 11 y buf[0] es_igual 109 y buf[1] es_igual 101 entonces
                                            si buf[2] es_igual 110 y buf[3] es_igual 111 entonces
                                                si buf[4] es_igual 114 y buf[5] es_igual 95 entonces
                                                    si buf[6] es_igual 105 y buf[7] es_igual 103 entonces
                                                        si buf[8] es_igual 117 y buf[9] es_igual 97 y buf[10] es_igual 108 entonces
                                                            wop es 9
                                                        listo
                                                    listo
                                                listo
                                            listo
                                        listo
                                        si wop es_mayor 0 entonces
                                            ; push rax (first operand)
                                            code[pos] es 0x50
                                            pos es pos mas 1
                                            mientras is_ws(c) es_igual 1 haga
                                                c es leer_byte()
                                            listo
                                            ; Parse second operand
                                            si is_digit(c) es_igual 1 entonces
                                                val es 0
                                                mientras is_digit(c) es_igual 1 haga
                                                    val es val por 10 mas (c menos 48)
                                                    c es leer_byte()
                                                listo
                                                ; mov rax, imm64
                                                numero wt2
                                                code[pos] es 0x48
                                                pos es pos mas 1
                                                code[pos] es 0xB8
                                                pos es pos mas 1
                                                wt2 es val
                                                code[pos] es wt2 menos ((wt2 entre 256) por 256)
                                                pos es pos mas 1
                                                wt2 es wt2 entre 256
                                                code[pos] es wt2 menos ((wt2 entre 256) por 256)
                                                pos es pos mas 1
                                                wt2 es wt2 entre 256
                                                code[pos] es wt2 menos ((wt2 entre 256) por 256)
                                                pos es pos mas 1
                                                wt2 es wt2 entre 256
                                                code[pos] es wt2
                                                pos es pos mas 1
                                                code[pos] es 0
                                                pos es pos mas 1
                                                code[pos] es 0
                                                pos es pos mas 1
                                                code[pos] es 0
                                                pos es pos mas 1
                                                code[pos] es 0
                                                pos es pos mas 1
                                            sino
                                                si is_alpha(c) es_igual 1 entonces
                                                    numero wh2
                                                    numero woff2
                                                    numero wi2
                                                    len es 0
                                                    mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                                        buf[len] es c
                                                        len es len mas 1
                                                        c es leer_byte()
                                                    listo
                                                    wh2 es buf[0]
                                                    woff2 es 0
                                                    wi2 es 0
                                                    mientras wi2 es_menor vcnt haga
                                                        si vname[wi2] es_igual wh2 entonces
                                                            woff2 es voff[wi2]
                                                        listo
                                                        wi2 es wi2 mas 1
                                                    listo
                                                    ; mov rax, [rbp+off]
                                                    code[pos] es 0x48
                                                    pos es pos mas 1
                                                    code[pos] es 0x8B
                                                    pos es pos mas 1
                                                    code[pos] es 0x45
                                                    pos es pos mas 1
                                                    code[pos] es woff2 mas 256
                                                    pos es pos mas 1
                                                listo
                                            listo
                                            ; pop rbx, xchg, compare
                                            code[pos] es 0x5B
                                            pos es pos mas 1
                                            code[pos] es 0x48
                                            pos es pos mas 1
                                            code[pos] es 0x87
                                            pos es pos mas 1
                                            code[pos] es 0xD8
                                            pos es pos mas 1
                                            ; cmp rax, rbx
                                            code[pos] es 0x48
                                            pos es pos mas 1
                                            code[pos] es 0x39
                                            pos es pos mas 1
                                            code[pos] es 0xD8
                                            pos es pos mas 1
                                            si wop es_igual 5 entonces
                                                ; sete al
                                                code[pos] es 0x0F
                                                pos es pos mas 1
                                                code[pos] es 0x94
                                                pos es pos mas 1
                                                code[pos] es 0xC0
                                                pos es pos mas 1
                                            listo
                                            si wop es_igual 6 entonces
                                                ; setl al
                                                code[pos] es 0x0F
                                                pos es pos mas 1
                                                code[pos] es 0x9C
                                                pos es pos mas 1
                                                code[pos] es 0xC0
                                                pos es pos mas 1
                                            listo
                                            si wop es_igual 7 entonces
                                                ; setg al
                                                code[pos] es 0x0F
                                                pos es pos mas 1
                                                code[pos] es 0x9F
                                                pos es pos mas 1
                                                code[pos] es 0xC0
                                                pos es pos mas 1
                                            listo
                                            si wop es_igual 8 entonces
                                                ; setge al
                                                code[pos] es 0x0F
                                                pos es pos mas 1
                                                code[pos] es 0x9D
                                                pos es pos mas 1
                                                code[pos] es 0xC0
                                                pos es pos mas 1
                                            listo
                                            si wop es_igual 9 entonces
                                                ; setle al
                                                code[pos] es 0x0F
                                                pos es pos mas 1
                                                code[pos] es 0x9E
                                                pos es pos mas 1
                                                code[pos] es 0xC0
                                                pos es pos mas 1
                                            listo
                                            ; movzx rax, al
                                            code[pos] es 0x48
                                            pos es pos mas 1
                                            code[pos] es 0x0F
                                            pos es pos mas 1
                                            code[pos] es 0xB6
                                            pos es pos mas 1
                                            code[pos] es 0xC0
                                            pos es pos mas 1
                                        listo
                                    listo
                                    ; Emit test rax, rax
                                    code[pos] es 0x48
                                    pos es pos mas 1
                                    code[pos] es 0x85
                                    pos es pos mas 1
                                    code[pos] es 0xC0
                                    pos es pos mas 1
                                    ; Emit jz with placeholder
                                    code[pos] es 0x74
                                    pos es pos mas 1
                                    jz_patch es pos
                                    code[pos] es 0x00
                                    pos es pos mas 1
                                    ; Skip "haga" keyword
                                    mientras is_ws(c) es_igual 1 haga
                                        c es leer_byte()
                                    listo
                                    len es 0
                                    mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                        buf[len] es c
                                        len es len mas 1
                                        c es leer_byte()
                                    listo
                                listo
                            listo
                        listo
                    listo
                listo

                ; si = 115,105 (2 chars) - conditional
                si len es_igual 2 y c es_mayor 0 entonces
                    si buf[0] es_igual 115 y buf[1] es_igual 105 entonces
                        ctrl_type es 2
                        si_jmp_patch es 0
                        mientras is_ws(c) es_igual 1 haga
                            c es leer_byte()
                        listo
                        ; Parse condition first operand
                        si is_digit(c) es_igual 1 entonces
                            val es 0
                            mientras is_digit(c) es_igual 1 haga
                                val es val por 10 mas (c menos 48)
                                c es leer_byte()
                            listo
                            ; mov rax, imm64
                            numero st
                            code[pos] es 0x48
                            pos es pos mas 1
                            code[pos] es 0xB8
                            pos es pos mas 1
                            st es val
                            code[pos] es st menos ((st entre 256) por 256)
                            pos es pos mas 1
                            st es st entre 256
                            code[pos] es st menos ((st entre 256) por 256)
                            pos es pos mas 1
                            st es st entre 256
                            code[pos] es st menos ((st entre 256) por 256)
                            pos es pos mas 1
                            st es st entre 256
                            code[pos] es st
                            pos es pos mas 1
                            code[pos] es 0
                            pos es pos mas 1
                            code[pos] es 0
                            pos es pos mas 1
                            code[pos] es 0
                            pos es pos mas 1
                            code[pos] es 0
                            pos es pos mas 1
                        sino
                            si is_alpha(c) es_igual 1 entonces
                                numero sh
                                numero soff
                                numero si2
                                len es 0
                                mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                    buf[len] es c
                                    len es len mas 1
                                    c es leer_byte()
                                listo
                                sh es buf[0]
                                soff es 0
                                si2 es 0
                                mientras si2 es_menor vcnt haga
                                    si vname[si2] es_igual sh entonces
                                        soff es voff[si2]
                                    listo
                                    si2 es si2 mas 1
                                listo
                                ; mov rax, [rbp+off]
                                code[pos] es 0x48
                                pos es pos mas 1
                                code[pos] es 0x8B
                                pos es pos mas 1
                                code[pos] es 0x45
                                pos es pos mas 1
                                code[pos] es soff mas 256
                                pos es pos mas 1
                            listo
                        listo
                        ; Skip whitespace
                        mientras is_ws(c) es_igual 1 haga
                            c es leer_byte()
                        listo
                        ; Parse comparison operator
                        si is_alpha(c) es_igual 1 entonces
                            numero sop
                            sop es 0
                            len es 0
                            mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                buf[len] es c
                                len es len mas 1
                                c es leer_byte()
                            listo
                            ; es_igual (8)
                            si len es_igual 8 y buf[0] es_igual 101 y buf[1] es_igual 115 entonces
                                si buf[2] es_igual 95 y buf[3] es_igual 105 entonces
                                    si buf[4] es_igual 103 y buf[5] es_igual 117 entonces
                                        si buf[6] es_igual 97 y buf[7] es_igual 108 entonces
                                            sop es 5
                                        listo
                                    listo
                                listo
                            listo
                            ; es_menor (8)
                            si len es_igual 8 y buf[0] es_igual 101 y buf[1] es_igual 115 entonces
                                si buf[2] es_igual 95 y buf[3] es_igual 109 entonces
                                    si buf[4] es_igual 101 y buf[5] es_igual 110 entonces
                                        si buf[6] es_igual 111 y buf[7] es_igual 114 entonces
                                            sop es 6
                                        listo
                                    listo
                                listo
                            listo
                            ; es_mayor (8)
                            si len es_igual 8 y buf[0] es_igual 101 y buf[1] es_igual 115 entonces
                                si buf[2] es_igual 95 y buf[3] es_igual 109 entonces
                                    si buf[4] es_igual 97 y buf[5] es_igual 121 entonces
                                        si buf[6] es_igual 111 y buf[7] es_igual 114 entonces
                                            sop es 7
                                        listo
                                    listo
                                listo
                            listo
                            ; mayor_igual (11)
                            si len es_igual 11 y buf[0] es_igual 109 y buf[1] es_igual 97 entonces
                                si buf[2] es_igual 121 y buf[3] es_igual 111 entonces
                                    si buf[4] es_igual 114 y buf[5] es_igual 95 entonces
                                        si buf[6] es_igual 105 y buf[7] es_igual 103 entonces
                                            si buf[8] es_igual 117 y buf[9] es_igual 97 y buf[10] es_igual 108 entonces
                                                sop es 8
                                            listo
                                        listo
                                    listo
                                listo
                            listo
                            ; menor_igual (11)
                            si len es_igual 11 y buf[0] es_igual 109 y buf[1] es_igual 101 entonces
                                si buf[2] es_igual 110 y buf[3] es_igual 111 entonces
                                    si buf[4] es_igual 114 y buf[5] es_igual 95 entonces
                                        si buf[6] es_igual 105 y buf[7] es_igual 103 entonces
                                            si buf[8] es_igual 117 y buf[9] es_igual 97 y buf[10] es_igual 108 entonces
                                                sop es 9
                                            listo
                                        listo
                                    listo
                                listo
                            listo
                            si sop es_mayor 0 entonces
                                ; push rax (first operand)
                                code[pos] es 0x50
                                pos es pos mas 1
                                mientras is_ws(c) es_igual 1 haga
                                    c es leer_byte()
                                listo
                                ; Parse second operand
                                si is_digit(c) es_igual 1 entonces
                                    val es 0
                                    mientras is_digit(c) es_igual 1 haga
                                        val es val por 10 mas (c menos 48)
                                        c es leer_byte()
                                    listo
                                    ; mov rax, imm64
                                    numero st2
                                    code[pos] es 0x48
                                    pos es pos mas 1
                                    code[pos] es 0xB8
                                    pos es pos mas 1
                                    st2 es val
                                    code[pos] es st2 menos ((st2 entre 256) por 256)
                                    pos es pos mas 1
                                    st2 es st2 entre 256
                                    code[pos] es st2 menos ((st2 entre 256) por 256)
                                    pos es pos mas 1
                                    st2 es st2 entre 256
                                    code[pos] es st2 menos ((st2 entre 256) por 256)
                                    pos es pos mas 1
                                    st2 es st2 entre 256
                                    code[pos] es st2
                                    pos es pos mas 1
                                    code[pos] es 0
                                    pos es pos mas 1
                                    code[pos] es 0
                                    pos es pos mas 1
                                    code[pos] es 0
                                    pos es pos mas 1
                                    code[pos] es 0
                                    pos es pos mas 1
                                sino
                                    si is_alpha(c) es_igual 1 entonces
                                        numero sh2
                                        numero soff2
                                        numero si3
                                        len es 0
                                        mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                            buf[len] es c
                                            len es len mas 1
                                            c es leer_byte()
                                        listo
                                        sh2 es buf[0]
                                        soff2 es 0
                                        si3 es 0
                                        mientras si3 es_menor vcnt haga
                                            si vname[si3] es_igual sh2 entonces
                                                soff2 es voff[si3]
                                            listo
                                            si3 es si3 mas 1
                                        listo
                                        ; mov rax, [rbp+off]
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x8B
                                        pos es pos mas 1
                                        code[pos] es 0x45
                                        pos es pos mas 1
                                        code[pos] es soff2 mas 256
                                        pos es pos mas 1
                                    listo
                                listo
                                ; pop rbx, xchg, compare
                                code[pos] es 0x5B
                                pos es pos mas 1
                                code[pos] es 0x48
                                pos es pos mas 1
                                code[pos] es 0x87
                                pos es pos mas 1
                                code[pos] es 0xD8
                                pos es pos mas 1
                                ; cmp rax, rbx
                                code[pos] es 0x48
                                pos es pos mas 1
                                code[pos] es 0x39
                                pos es pos mas 1
                                code[pos] es 0xD8
                                pos es pos mas 1
                                si sop es_igual 5 entonces
                                    ; sete al
                                    code[pos] es 0x0F
                                    pos es pos mas 1
                                    code[pos] es 0x94
                                    pos es pos mas 1
                                    code[pos] es 0xC0
                                    pos es pos mas 1
                                listo
                                si sop es_igual 6 entonces
                                    ; setl al
                                    code[pos] es 0x0F
                                    pos es pos mas 1
                                    code[pos] es 0x9C
                                    pos es pos mas 1
                                    code[pos] es 0xC0
                                    pos es pos mas 1
                                listo
                                si sop es_igual 7 entonces
                                    ; setg al
                                    code[pos] es 0x0F
                                    pos es pos mas 1
                                    code[pos] es 0x9F
                                    pos es pos mas 1
                                    code[pos] es 0xC0
                                    pos es pos mas 1
                                listo
                                si sop es_igual 8 entonces
                                    ; setge al
                                    code[pos] es 0x0F
                                    pos es pos mas 1
                                    code[pos] es 0x9D
                                    pos es pos mas 1
                                    code[pos] es 0xC0
                                    pos es pos mas 1
                                listo
                                si sop es_igual 9 entonces
                                    ; setle al
                                    code[pos] es 0x0F
                                    pos es pos mas 1
                                    code[pos] es 0x9E
                                    pos es pos mas 1
                                    code[pos] es 0xC0
                                    pos es pos mas 1
                                listo
                                ; movzx rax, al
                                code[pos] es 0x48
                                pos es pos mas 1
                                code[pos] es 0x0F
                                pos es pos mas 1
                                code[pos] es 0xB6
                                pos es pos mas 1
                                code[pos] es 0xC0
                                pos es pos mas 1
                            listo
                        listo
                        ; Emit test rax, rax
                        code[pos] es 0x48
                        pos es pos mas 1
                        code[pos] es 0x85
                        pos es pos mas 1
                        code[pos] es 0xC0
                        pos es pos mas 1
                        ; Emit jz with placeholder
                        code[pos] es 0x74
                        pos es pos mas 1
                        si_jz_patch es pos
                        code[pos] es 0x00
                        pos es pos mas 1
                        ; Skip "entonces" keyword
                        mientras is_ws(c) es_igual 1 haga
                            c es leer_byte()
                        listo
                        len es 0
                        mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                            buf[len] es c
                            len es len mas 1
                            c es leer_byte()
                        listo
                    listo
                listo

                ; sino = 115,105,110,111 (4 chars)
                si len es_igual 4 entonces
                    si buf[0] es_igual 115 y buf[1] es_igual 105 entonces
                        si buf[2] es_igual 110 y buf[3] es_igual 111 entonces
                            ; Emit jmp to skip else body
                            code[pos] es 0xEB
                            pos es pos mas 1
                            si_jmp_patch es pos
                            code[pos] es 0x00
                            pos es pos mas 1
                            ; Backpatch si_jz_patch to jump here
                            numero si_fwd
                            si_fwd es pos menos si_jz_patch menos 1
                            code[si_jz_patch] es si_fwd
                        listo
                    listo
                listo

                ; listo = 108,105,115,116,111 (5 chars)
                si len es_igual 5 entonces
                    si buf[0] es_igual 108 y buf[1] es_igual 105 entonces
                        si buf[2] es_igual 115 y buf[3] es_igual 116 entonces
                            si buf[4] es_igual 111 entonces
                                si ctrl_type es_igual 1 entonces
                                    ; mientras: emit jmp back and backpatch jz
                                    numero back_off
                                    back_off es loop_start menos pos menos 2
                                    code[pos] es 0xEB
                                    pos es pos mas 1
                                    code[pos] es back_off mas 256
                                    pos es pos mas 1
                                    numero fwd_off
                                    fwd_off es pos menos jz_patch menos 1
                                    code[jz_patch] es fwd_off
                                    ctrl_type es 0
                                listo
                                si ctrl_type es_igual 2 entonces
                                    ; si: backpatch forward jump
                                    si si_jmp_patch es_mayor 0 entonces
                                        ; Had sino, backpatch the jmp
                                        numero si_end
                                        si_end es pos menos si_jmp_patch menos 1
                                        code[si_jmp_patch] es si_end
                                    sino
                                        ; No sino, backpatch the jz
                                        numero si_end2
                                        si_end2 es pos menos si_jz_patch menos 1
                                        code[si_jz_patch] es si_end2
                                    listo
                                    ctrl_type es 0
                                listo
                            listo
                        listo
                    listo
                listo

                ; devuelvase
                si len es_igual 10 y c es_mayor 0 entonces
                    si buf[0] es_igual 100 y buf[1] es_igual 101 entonces
                        si buf[2] es_igual 118 y buf[3] es_igual 117 entonces
                            si buf[4] es_igual 101 y buf[5] es_igual 108 entonces
                                si buf[6] es_igual 118 y buf[7] es_igual 97 entonces
                                    si buf[8] es_igual 115 y buf[9] es_igual 101 entonces
                                        mientras is_ws(c) es_igual 1 haga
                                            c es leer_byte()
                                        listo
                                        si is_digit(c) es_igual 1 entonces
                                            val es 0
                                            mientras is_digit(c) es_igual 1 haga
                                                val es val por 10 mas (c menos 48)
                                                c es leer_byte()
                                            listo
                                            ; mov rax, imm64 to buffer
                                            code[pos] es 0x48
                                            pos es pos mas 1
                                            code[pos] es 0xB8
                                            pos es pos mas 1
                                            numero vt
                                            vt es val
                                            code[pos] es vt menos ((vt entre 256) por 256)
                                            pos es pos mas 1
                                            vt es vt entre 256
                                            code[pos] es vt menos ((vt entre 256) por 256)
                                            pos es pos mas 1
                                            vt es vt entre 256
                                            code[pos] es vt menos ((vt entre 256) por 256)
                                            pos es pos mas 1
                                            vt es vt entre 256
                                            code[pos] es vt
                                            pos es pos mas 1
                                            code[pos] es 0
                                            pos es pos mas 1
                                            code[pos] es 0
                                            pos es pos mas 1
                                            code[pos] es 0
                                            pos es pos mas 1
                                            code[pos] es 0
                                            pos es pos mas 1
                                            ; Emit return epilogue for literal devuelvase
                                            si fname[fcnt menos 1] es_igual 112 entonces
                                                ; principal: exit syscall
                                                code[pos] es 0x48
                                                pos es pos mas 1
                                                code[pos] es 0x89
                                                pos es pos mas 1
                                                code[pos] es 0xEC
                                                pos es pos mas 1
                                                code[pos] es 0x5D
                                                pos es pos mas 1
                                                code[pos] es 0x48
                                                pos es pos mas 1
                                                code[pos] es 0x89
                                                pos es pos mas 1
                                                code[pos] es 0xC7
                                                pos es pos mas 1
                                                code[pos] es 0xB8
                                                pos es pos mas 1
                                                code[pos] es 0x3C
                                                pos es pos mas 1
                                                code[pos] es 0x00
                                                pos es pos mas 1
                                                code[pos] es 0x00
                                                pos es pos mas 1
                                                code[pos] es 0x00
                                                pos es pos mas 1
                                                code[pos] es 0x0F
                                                pos es pos mas 1
                                                code[pos] es 0x05
                                                pos es pos mas 1
                                            sino
                                                ; non-principal: ret
                                                code[pos] es 0x48
                                                pos es pos mas 1
                                                code[pos] es 0x89
                                                pos es pos mas 1
                                                code[pos] es 0xEC
                                                pos es pos mas 1
                                                code[pos] es 0x5D
                                                pos es pos mas 1
                                                code[pos] es 0xC3
                                                pos es pos mas 1
                                            listo
                                        sino
                                            si is_alpha(c) es_igual 1 entonces
                                                len es 0
                                                mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                                    buf[len] es c
                                                    len es len mas 1
                                                    c es leer_byte()
                                                listo
                                                h es buf[0]
                                                si c es_igual 91 entonces
                                                    ; Array read in devuelvase
                                                    c es leer_byte()
                                                    val es 0
                                                    mientras is_digit(c) es_igual 1 haga
                                                        val es val por 10 mas (c menos 48)
                                                        c es leer_byte()
                                                    listo
                                                    si c es_igual 93 entonces
                                                        c es leer_byte()
                                                    listo
                                                    off es 0
                                                    i es 0
                                                    mientras i es_menor acnt haga
                                                        si aname[i] es_igual h entonces
                                                            off es aoff[i]
                                                        listo
                                                        i es i mas 1
                                                    listo
                                                    off es off mas (val por 8)
                                                    code[pos] es 0x48
                                                    pos es pos mas 1
                                                    code[pos] es 0x8B
                                                    pos es pos mas 1
                                                    code[pos] es 0x45
                                                    pos es pos mas 1
                                                    code[pos] es off mas 256
                                                    pos es pos mas 1
                                                sino
                                                    off es 0
                                                    i es 0
                                                    mientras i es_menor vcnt haga
                                                        si vname[i] es_igual h entonces
                                                            off es voff[i]
                                                        listo
                                                        i es i mas 1
                                                    listo
                                                    code[pos] es 0x48
                                                    pos es pos mas 1
                                                    code[pos] es 0x8B
                                                    pos es pos mas 1
                                                    code[pos] es 0x45
                                                    pos es pos mas 1
                                                    code[pos] es off mas 256
                                                    pos es pos mas 1
                                                listo
                                                ; Check for operator after first operand in devuelvase
                                                mientras is_ws(c) es_igual 1 haga
                                                    c es leer_byte()
                                                listo
                                                ; Only check if c could start an operator: m(109), p(112), e(101)
                                                si c es_igual 109 o c es_igual 112 o c es_igual 101 entonces
                                                    len es 0
                                                    mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                                        buf[len] es c
                                                        len es len mas 1
                                                        c es leer_byte()
                                                    listo
                                                    numero rop
                                                    rop es 0
                                                    si len es_igual 3 y buf[0] es_igual 109 entonces
                                                        si buf[1] es_igual 97 y buf[2] es_igual 115 entonces
                                                            rop es 1
                                                        listo
                                                    listo
                                                    si len es_igual 5 y buf[0] es_igual 109 entonces
                                                        si buf[1] es_igual 101 y buf[2] es_igual 110 entonces
                                                            si buf[3] es_igual 111 y buf[4] es_igual 115 entonces
                                                                rop es 2
                                                            listo
                                                        listo
                                                    listo
                                                    si len es_igual 3 y buf[0] es_igual 112 entonces
                                                        si buf[1] es_igual 111 y buf[2] es_igual 114 entonces
                                                            rop es 3
                                                        listo
                                                    listo
                                                    si len es_igual 5 y buf[0] es_igual 101 entonces
                                                        si buf[1] es_igual 110 y buf[2] es_igual 116 entonces
                                                            si buf[3] es_igual 114 y buf[4] es_igual 101 entonces
                                                                rop es 4
                                                            listo
                                                        listo
                                                    listo
                                                    si rop es_mayor 0 entonces
                                                        code[pos] es 0x50
                                                        pos es pos mas 1
                                                        mientras is_ws(c) es_igual 1 haga
                                                            c es leer_byte()
                                                        listo
                                                        si is_digit(c) es_igual 1 entonces
                                                            val es 0
                                                            mientras is_digit(c) es_igual 1 haga
                                                                val es val por 10 mas (c menos 48)
                                                                c es leer_byte()
                                                            listo
                                                            numero rvt
                                                            code[pos] es 0x48
                                                            pos es pos mas 1
                                                            code[pos] es 0xB8
                                                            pos es pos mas 1
                                                            rvt es val
                                                            code[pos] es rvt menos ((rvt entre 256) por 256)
                                                            pos es pos mas 1
                                                            rvt es rvt entre 256
                                                            code[pos] es rvt menos ((rvt entre 256) por 256)
                                                            pos es pos mas 1
                                                            rvt es rvt entre 256
                                                            code[pos] es rvt menos ((rvt entre 256) por 256)
                                                            pos es pos mas 1
                                                            rvt es rvt entre 256
                                                            code[pos] es rvt
                                                            pos es pos mas 1
                                                            code[pos] es 0
                                                            pos es pos mas 1
                                                            code[pos] es 0
                                                            pos es pos mas 1
                                                            code[pos] es 0
                                                            pos es pos mas 1
                                                            code[pos] es 0
                                                            pos es pos mas 1
                                                        sino
                                                            si is_alpha(c) es_igual 1 entonces
                                                                len es 0
                                                                mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                                                    buf[len] es c
                                                                    len es len mas 1
                                                                    c es leer_byte()
                                                                listo
                                                                h2 es buf[0]
                                                                numero roff
                                                                numero ri
                                                                roff es 0
                                                                ri es 0
                                                                mientras ri es_menor vcnt haga
                                                                    si vname[ri] es_igual h2 entonces
                                                                        roff es voff[ri]
                                                                    listo
                                                                    ri es ri mas 1
                                                                listo
                                                                code[pos] es 0x48
                                                                pos es pos mas 1
                                                                code[pos] es 0x8B
                                                                pos es pos mas 1
                                                                code[pos] es 0x45
                                                                pos es pos mas 1
                                                                code[pos] es roff mas 256
                                                                pos es pos mas 1
                                                            listo
                                                        listo
                                                        code[pos] es 0x5B
                                                        pos es pos mas 1
                                                        code[pos] es 0x48
                                                        pos es pos mas 1
                                                        code[pos] es 0x87
                                                        pos es pos mas 1
                                                        code[pos] es 0xD8
                                                        pos es pos mas 1
                                                        si rop es_igual 1 entonces
                                                            code[pos] es 0x48
                                                            pos es pos mas 1
                                                            code[pos] es 0x01
                                                            pos es pos mas 1
                                                            code[pos] es 0xD8
                                                            pos es pos mas 1
                                                        listo
                                                        si rop es_igual 2 entonces
                                                            code[pos] es 0x48
                                                            pos es pos mas 1
                                                            code[pos] es 0x29
                                                            pos es pos mas 1
                                                            code[pos] es 0xD8
                                                            pos es pos mas 1
                                                        listo
                                                        si rop es_igual 3 entonces
                                                            code[pos] es 0x48
                                                            pos es pos mas 1
                                                            code[pos] es 0x0F
                                                            pos es pos mas 1
                                                            code[pos] es 0xAF
                                                            pos es pos mas 1
                                                            code[pos] es 0xC3
                                                            pos es pos mas 1
                                                        listo
                                                        si rop es_igual 4 entonces
                                                            code[pos] es 0x48
                                                            pos es pos mas 1
                                                            code[pos] es 0x99
                                                            pos es pos mas 1
                                                            code[pos] es 0x48
                                                            pos es pos mas 1
                                                            code[pos] es 0xF7
                                                            pos es pos mas 1
                                                            code[pos] es 0xFB
                                                            pos es pos mas 1
                                                        listo
                                                    listo
                                                listo
                                            listo
                                            ; Emit return epilogue for variable/expression devuelvase
                                            si fname[fcnt menos 1] es_igual 112 entonces
                                                ; principal: exit syscall
                                                code[pos] es 0x48
                                                pos es pos mas 1
                                                code[pos] es 0x89
                                                pos es pos mas 1
                                                code[pos] es 0xEC
                                                pos es pos mas 1
                                                code[pos] es 0x5D
                                                pos es pos mas 1
                                                code[pos] es 0x48
                                                pos es pos mas 1
                                                code[pos] es 0x89
                                                pos es pos mas 1
                                                code[pos] es 0xC7
                                                pos es pos mas 1
                                                code[pos] es 0xB8
                                                pos es pos mas 1
                                                code[pos] es 0x3C
                                                pos es pos mas 1
                                                code[pos] es 0x00
                                                pos es pos mas 1
                                                code[pos] es 0x00
                                                pos es pos mas 1
                                                code[pos] es 0x00
                                                pos es pos mas 1
                                                code[pos] es 0x0F
                                                pos es pos mas 1
                                                code[pos] es 0x05
                                                pos es pos mas 1
                                            sino
                                                ; non-principal: ret
                                                code[pos] es 0x48
                                                pos es pos mas 1
                                                code[pos] es 0x89
                                                pos es pos mas 1
                                                code[pos] es 0xEC
                                                pos es pos mas 1
                                                code[pos] es 0x5D
                                                pos es pos mas 1
                                                code[pos] es 0xC3
                                                pos es pos mas 1
                                            listo
                                        listo
                                    listo
                                listo
                            listo
                        listo
                    listo
                listo

                ; assignment
                si c es_mayor 0 entonces
                    mientras is_ws(c) es_igual 1 haga
                        c es leer_byte()
                    listo
                    ; Array write: arr[i] es val
                    si c es_igual 91 entonces
                        h es buf[0]
                        c es leer_byte()
                        val es 0
                        mientras is_digit(c) es_igual 1 haga
                            val es val por 10 mas (c menos 48)
                            c es leer_byte()
                        listo
                        si c es_igual 93 entonces
                            c es leer_byte()
                        listo
                        mientras is_ws(c) es_igual 1 haga
                            c es leer_byte()
                        listo
                        ; expect 'es'
                        si c es_igual 101 entonces
                            numero an2
                            an2 es leer_byte()
                            si an2 es_igual 115 entonces
                                c es leer_byte()
                                mientras is_ws(c) es_igual 1 haga
                                    c es leer_byte()
                                listo
                                ; Look up array base
                                off es 0
                                i es 0
                                mientras i es_menor acnt haga
                                    si aname[i] es_igual h entonces
                                        off es aoff[i]
                                    listo
                                    i es i mas 1
                                listo
                                off es off mas (val por 8)
                                ; Parse value (number only for now)
                                si is_digit(c) es_igual 1 entonces
                                    numero aval
                                    aval es 0
                                    mientras is_digit(c) es_igual 1 haga
                                        aval es aval por 10 mas (c menos 48)
                                        c es leer_byte()
                                    listo
                                    ; mov rax, imm64
                                    numero avt
                                    code[pos] es 0x48
                                    pos es pos mas 1
                                    code[pos] es 0xB8
                                    pos es pos mas 1
                                    avt es aval
                                    code[pos] es avt menos ((avt entre 256) por 256)
                                    pos es pos mas 1
                                    avt es avt entre 256
                                    code[pos] es avt menos ((avt entre 256) por 256)
                                    pos es pos mas 1
                                    avt es avt entre 256
                                    code[pos] es avt menos ((avt entre 256) por 256)
                                    pos es pos mas 1
                                    avt es avt entre 256
                                    code[pos] es avt
                                    pos es pos mas 1
                                    code[pos] es 0
                                    pos es pos mas 1
                                    code[pos] es 0
                                    pos es pos mas 1
                                    code[pos] es 0
                                    pos es pos mas 1
                                    code[pos] es 0
                                    pos es pos mas 1
                                    ; mov [rbp+off], rax = 48 89 45 off
                                    code[pos] es 0x48
                                    pos es pos mas 1
                                    code[pos] es 0x89
                                    pos es pos mas 1
                                    code[pos] es 0x45
                                    pos es pos mas 1
                                    code[pos] es off mas 256
                                    pos es pos mas 1
                                listo
                            listo
                        listo
                    listo
                    si c es_igual 101 entonces
                        numero n2
                        n2 es leer_byte()
                        si n2 es_igual 115 entonces
                            c es leer_byte()
                            mientras is_ws(c) es_igual 1 haga
                                c es leer_byte()
                            listo
                            h es buf[0]
                            off es 0
                            i es 0
                            mientras i es_menor vcnt haga
                                si vname[i] es_igual h entonces
                                    off es voff[i]
                                listo
                                i es i mas 1
                            listo
                            ; Parse first operand (number or variable)
                            si is_digit(c) es_igual 1 entonces
                                val es 0
                                mientras is_digit(c) es_igual 1 haga
                                    val es val por 10 mas (c menos 48)
                                    c es leer_byte()
                                listo
                                ; mov rax, imm64 to buffer
                                numero vt2
                                code[pos] es 0x48
                                pos es pos mas 1
                                code[pos] es 0xB8
                                pos es pos mas 1
                                vt2 es val
                                code[pos] es vt2 menos ((vt2 entre 256) por 256)
                                pos es pos mas 1
                                vt2 es vt2 entre 256
                                code[pos] es vt2 menos ((vt2 entre 256) por 256)
                                pos es pos mas 1
                                vt2 es vt2 entre 256
                                code[pos] es vt2 menos ((vt2 entre 256) por 256)
                                pos es pos mas 1
                                vt2 es vt2 entre 256
                                code[pos] es vt2
                                pos es pos mas 1
                                code[pos] es 0
                                pos es pos mas 1
                                code[pos] es 0
                                pos es pos mas 1
                                code[pos] es 0
                                pos es pos mas 1
                                code[pos] es 0
                                pos es pos mas 1
                            sino
                                si is_alpha(c) es_igual 1 entonces
                                    numero vh
                                    len es 0
                                    mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                        buf[len] es c
                                        len es len mas 1
                                        c es leer_byte()
                                    listo
                                    vh es buf[0]
                                    si c es_igual 40 entonces
                                        ; Function call: name()
                                        c es leer_byte()
                                        ; Skip to )
                                        mientras c es_mayor 0 y (no (c es_igual 41)) haga
                                            c es leer_byte()
                                        listo
                                        si c es_igual 41 entonces
                                            c es leer_byte()
                                        listo
                                        ; Look up function
                                        numero foff2
                                        numero fi2
                                        foff2 es 0
                                        fi2 es 0
                                        mientras fi2 es_menor fcnt haga
                                            si fname[fi2] es_igual vh entonces
                                                foff2 es foff[fi2]
                                                fi2 es fcnt
                                            sino
                                                fi2 es fi2 mas 1
                                            listo
                                        listo
                                        ; Emit call rel32 (E8 xx xx xx xx)
                                        numero call_off
                                        call_off es foff2 menos pos menos 5
                                        ; Convert negative to unsigned 32-bit
                                        si call_off es_menor 0 entonces
                                            call_off es call_off mas 4294967296
                                        listo
                                        code[pos] es 0xE8
                                        pos es pos mas 1
                                        code[pos] es call_off menos ((call_off entre 256) por 256)
                                        pos es pos mas 1
                                        code[pos] es (call_off entre 256) menos (((call_off entre 256) entre 256) por 256)
                                        pos es pos mas 1
                                        code[pos] es (call_off entre 65536) menos (((call_off entre 65536) entre 256) por 256)
                                        pos es pos mas 1
                                        code[pos] es call_off entre 16777216
                                        pos es pos mas 1
                                    sino
                                        si c es_igual 91 entonces
                                            ; Simple array read - skip to ] and emit mov
                                            numero aoff2
                                            numero ai2
                                            c es leer_byte()
                                            val es 0
                                            mientras is_digit(c) es_igual 1 haga
                                                val es val por 10 mas (c menos 48)
                                                c es leer_byte()
                                            listo
                                            si c es_igual 93 entonces
                                                c es leer_byte()
                                            listo
                                            ; Look up array base
                                            aoff2 es 0
                                            ai2 es 0
                                            mientras ai2 es_menor acnt haga
                                                si aname[ai2] es_igual vh entonces
                                                    aoff2 es aoff[ai2]
                                                listo
                                                ai2 es ai2 mas 1
                                            listo
                                            aoff2 es aoff2 mas (val por 8)
                                            code[pos] es 0x48
                                            pos es pos mas 1
                                            code[pos] es 0x8B
                                            pos es pos mas 1
                                            code[pos] es 0x45
                                            pos es pos mas 1
                                            code[pos] es aoff2 mas 256
                                            pos es pos mas 1
                                        sino
                                            numero voff2
                                            numero vi
                                            voff2 es 0
                                            vi es 0
                                            mientras vi es_menor vcnt haga
                                                si vname[vi] es_igual vh entonces
                                                    voff2 es voff[vi]
                                                listo
                                                vi es vi mas 1
                                            listo
                                            code[pos] es 0x48
                                            pos es pos mas 1
                                            code[pos] es 0x8B
                                            pos es pos mas 1
                                            code[pos] es 0x45
                                            pos es pos mas 1
                                            code[pos] es voff2 mas 256
                                            pos es pos mas 1
                                        listo
                                    listo
                                listo
                            listo
                            ; Check for operator - only skip spaces, not newlines
                            mientras (c es_igual 32 o c es_igual 9) haga
                                c es leer_byte()
                            listo
                            ; Only parse operator if starts with m (mas,menos), p (por), e (entre)
                            si (c es_igual 109 o c es_igual 112 o c es_igual 101) entonces
                                numero op
                                op es 0
                                len es 0
                                mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                    buf[len] es c
                                    len es len mas 1
                                    c es leer_byte()
                                listo
                                ; mas = 109,97,115
                                si len es_igual 3 y buf[0] es_igual 109 y buf[1] es_igual 97 y buf[2] es_igual 115 entonces
                                    op es 1
                                listo
                                ; menos = 109,101,110,111,115
                                si len es_igual 5 y buf[0] es_igual 109 y buf[1] es_igual 101 entonces
                                    si buf[2] es_igual 110 y buf[3] es_igual 111 y buf[4] es_igual 115 entonces
                                        op es 2
                                    listo
                                listo
                                ; por = 112,111,114
                                si len es_igual 3 y buf[0] es_igual 112 y buf[1] es_igual 111 y buf[2] es_igual 114 entonces
                                    op es 3
                                listo
                                ; entre = 101,110,116,114,101
                                si len es_igual 5 y buf[0] es_igual 101 y buf[1] es_igual 110 entonces
                                    si buf[2] es_igual 116 y buf[3] es_igual 114 y buf[4] es_igual 101 entonces
                                        op es 4
                                    listo
                                listo
                                ; es_igual = 101,115,95,105,103,117,97,108 (8 chars)
                                si len es_igual 8 y buf[0] es_igual 101 y buf[1] es_igual 115 entonces
                                    si buf[2] es_igual 95 y buf[3] es_igual 105 entonces
                                        si buf[4] es_igual 103 y buf[5] es_igual 117 entonces
                                            si buf[6] es_igual 97 y buf[7] es_igual 108 entonces
                                                op es 5
                                            listo
                                        listo
                                    listo
                                listo
                                ; es_menor = 101,115,95,109,101,110,111,114 (8 chars)
                                si len es_igual 8 y buf[0] es_igual 101 y buf[1] es_igual 115 entonces
                                    si buf[2] es_igual 95 y buf[3] es_igual 109 entonces
                                        si buf[4] es_igual 101 y buf[5] es_igual 110 entonces
                                            si buf[6] es_igual 111 y buf[7] es_igual 114 entonces
                                                op es 6
                                            listo
                                        listo
                                    listo
                                listo
                                ; es_mayor = 101,115,95,109,97,121,111,114 (8 chars)
                                si len es_igual 8 y buf[0] es_igual 101 y buf[1] es_igual 115 entonces
                                    si buf[2] es_igual 95 y buf[3] es_igual 109 entonces
                                        si buf[4] es_igual 97 y buf[5] es_igual 121 entonces
                                            si buf[6] es_igual 111 y buf[7] es_igual 114 entonces
                                                op es 7
                                            listo
                                        listo
                                    listo
                                listo
                                ; mayor_igual = 109,97,121,111,114,95,105,103,117,97,108 (11 chars)
                                si len es_igual 11 y buf[0] es_igual 109 y buf[1] es_igual 97 entonces
                                    si buf[2] es_igual 121 y buf[3] es_igual 111 entonces
                                        si buf[4] es_igual 114 y buf[5] es_igual 95 entonces
                                            si buf[6] es_igual 105 y buf[7] es_igual 103 entonces
                                                si buf[8] es_igual 117 y buf[9] es_igual 97 y buf[10] es_igual 108 entonces
                                                    op es 8
                                                listo
                                            listo
                                        listo
                                    listo
                                listo
                                ; menor_igual = 109,101,110,111,114,95,105,103,117,97,108 (11 chars)
                                si len es_igual 11 y buf[0] es_igual 109 y buf[1] es_igual 101 entonces
                                    si buf[2] es_igual 110 y buf[3] es_igual 111 entonces
                                        si buf[4] es_igual 114 y buf[5] es_igual 95 entonces
                                            si buf[6] es_igual 105 y buf[7] es_igual 103 entonces
                                                si buf[8] es_igual 117 y buf[9] es_igual 97 y buf[10] es_igual 108 entonces
                                                    op es 9
                                                listo
                                            listo
                                        listo
                                    listo
                                listo
                                si op es_mayor 0 entonces
                                    ; push rax
                                    code[pos] es 0x50
                                    pos es pos mas 1
                                    mientras is_ws(c) es_igual 1 haga
                                        c es leer_byte()
                                    listo
                                    ; Parse second operand
                                    si is_digit(c) es_igual 1 entonces
                                        val es 0
                                        mientras is_digit(c) es_igual 1 haga
                                            val es val por 10 mas (c menos 48)
                                            c es leer_byte()
                                        listo
                                        ; mov rax, imm64
                                        numero vt3
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0xB8
                                        pos es pos mas 1
                                        vt3 es val
                                        code[pos] es vt3 menos ((vt3 entre 256) por 256)
                                        pos es pos mas 1
                                        vt3 es vt3 entre 256
                                        code[pos] es vt3 menos ((vt3 entre 256) por 256)
                                        pos es pos mas 1
                                        vt3 es vt3 entre 256
                                        code[pos] es vt3 menos ((vt3 entre 256) por 256)
                                        pos es pos mas 1
                                        vt3 es vt3 entre 256
                                        code[pos] es vt3
                                        pos es pos mas 1
                                        code[pos] es 0
                                        pos es pos mas 1
                                        code[pos] es 0
                                        pos es pos mas 1
                                        code[pos] es 0
                                        pos es pos mas 1
                                        code[pos] es 0
                                        pos es pos mas 1
                                    sino
                                        si is_alpha(c) es_igual 1 entonces
                                            len es 0
                                            mientras is_alnum(c) es_igual 1 y len es_menor 15 haga
                                                buf[len] es c
                                                len es len mas 1
                                                c es leer_byte()
                                            listo
                                            h2 es buf[0]
                                            si c es_igual 91 entonces
                                                ; Array read in second operand
                                                numero aoff3
                                                numero ai3
                                                c es leer_byte()
                                                val es 0
                                                mientras is_digit(c) es_igual 1 haga
                                                    val es val por 10 mas (c menos 48)
                                                    c es leer_byte()
                                                listo
                                                si c es_igual 93 entonces
                                                    c es leer_byte()
                                                listo
                                                aoff3 es 0
                                                ai3 es 0
                                                mientras ai3 es_menor acnt haga
                                                    si aname[ai3] es_igual h2 entonces
                                                        aoff3 es aoff[ai3]
                                                    listo
                                                    ai3 es ai3 mas 1
                                                listo
                                                aoff3 es aoff3 mas (val por 8)
                                                code[pos] es 0x48
                                                pos es pos mas 1
                                                code[pos] es 0x8B
                                                pos es pos mas 1
                                                code[pos] es 0x45
                                                pos es pos mas 1
                                                code[pos] es aoff3 mas 256
                                                pos es pos mas 1
                                            sino
                                                numero voff3
                                                numero vi2
                                                voff3 es 0
                                                vi2 es 0
                                                mientras vi2 es_menor vcnt haga
                                                    si vname[vi2] es_igual h2 entonces
                                                        voff3 es voff[vi2]
                                                    listo
                                                    vi2 es vi2 mas 1
                                                listo
                                                ; mov rax, [rbp+off]
                                                code[pos] es 0x48
                                                pos es pos mas 1
                                                code[pos] es 0x8B
                                                pos es pos mas 1
                                                code[pos] es 0x45
                                                pos es pos mas 1
                                                code[pos] es voff3 mas 256
                                                pos es pos mas 1
                                            listo
                                        listo
                                    listo
                                    ; Now rbx=left, rax=right, apply op
                                    ; pop rbx
                                    code[pos] es 0x5B
                                    pos es pos mas 1
                                    ; xchg rax,rbx
                                    code[pos] es 0x48
                                    pos es pos mas 1
                                    code[pos] es 0x87
                                    pos es pos mas 1
                                    code[pos] es 0xD8
                                    pos es pos mas 1
                                    si op es_igual 1 entonces
                                        ; add rax, rbx
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x01
                                        pos es pos mas 1
                                        code[pos] es 0xD8
                                        pos es pos mas 1
                                    listo
                                    si op es_igual 2 entonces
                                        ; sub rax, rbx
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x29
                                        pos es pos mas 1
                                        code[pos] es 0xD8
                                        pos es pos mas 1
                                    listo
                                    si op es_igual 3 entonces
                                        ; imul rax, rbx
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x0F
                                        pos es pos mas 1
                                        code[pos] es 0xAF
                                        pos es pos mas 1
                                        code[pos] es 0xC3
                                        pos es pos mas 1
                                    listo
                                    si op es_igual 4 entonces
                                        ; cqo + idiv rbx
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x99
                                        pos es pos mas 1
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0xF7
                                        pos es pos mas 1
                                        code[pos] es 0xFB
                                        pos es pos mas 1
                                    listo
                                    ; Comparisons: cmp, setX, movzx
                                    si op es_igual 5 entonces
                                        ; cmp rax, rbx
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x39
                                        pos es pos mas 1
                                        code[pos] es 0xD8
                                        pos es pos mas 1
                                        ; sete al
                                        code[pos] es 0x0F
                                        pos es pos mas 1
                                        code[pos] es 0x94
                                        pos es pos mas 1
                                        code[pos] es 0xC0
                                        pos es pos mas 1
                                        ; movzx rax, al
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x0F
                                        pos es pos mas 1
                                        code[pos] es 0xB6
                                        pos es pos mas 1
                                        code[pos] es 0xC0
                                        pos es pos mas 1
                                    listo
                                    si op es_igual 6 entonces
                                        ; cmp rax, rbx
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x39
                                        pos es pos mas 1
                                        code[pos] es 0xD8
                                        pos es pos mas 1
                                        ; setl al
                                        code[pos] es 0x0F
                                        pos es pos mas 1
                                        code[pos] es 0x9C
                                        pos es pos mas 1
                                        code[pos] es 0xC0
                                        pos es pos mas 1
                                        ; movzx rax, al
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x0F
                                        pos es pos mas 1
                                        code[pos] es 0xB6
                                        pos es pos mas 1
                                        code[pos] es 0xC0
                                        pos es pos mas 1
                                    listo
                                    si op es_igual 7 entonces
                                        ; cmp rax, rbx
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x39
                                        pos es pos mas 1
                                        code[pos] es 0xD8
                                        pos es pos mas 1
                                        ; setg al
                                        code[pos] es 0x0F
                                        pos es pos mas 1
                                        code[pos] es 0x9F
                                        pos es pos mas 1
                                        code[pos] es 0xC0
                                        pos es pos mas 1
                                        ; movzx rax, al
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x0F
                                        pos es pos mas 1
                                        code[pos] es 0xB6
                                        pos es pos mas 1
                                        code[pos] es 0xC0
                                        pos es pos mas 1
                                    listo
                                    si op es_igual 8 entonces
                                        ; cmp rax, rbx
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x39
                                        pos es pos mas 1
                                        code[pos] es 0xD8
                                        pos es pos mas 1
                                        ; setge al
                                        code[pos] es 0x0F
                                        pos es pos mas 1
                                        code[pos] es 0x9D
                                        pos es pos mas 1
                                        code[pos] es 0xC0
                                        pos es pos mas 1
                                        ; movzx rax, al
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x0F
                                        pos es pos mas 1
                                        code[pos] es 0xB6
                                        pos es pos mas 1
                                        code[pos] es 0xC0
                                        pos es pos mas 1
                                    listo
                                    si op es_igual 9 entonces
                                        ; cmp rax, rbx
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x39
                                        pos es pos mas 1
                                        code[pos] es 0xD8
                                        pos es pos mas 1
                                        ; setle al
                                        code[pos] es 0x0F
                                        pos es pos mas 1
                                        code[pos] es 0x9E
                                        pos es pos mas 1
                                        code[pos] es 0xC0
                                        pos es pos mas 1
                                        ; movzx rax, al
                                        code[pos] es 0x48
                                        pos es pos mas 1
                                        code[pos] es 0x0F
                                        pos es pos mas 1
                                        code[pos] es 0xB6
                                        pos es pos mas 1
                                        code[pos] es 0xC0
                                        pos es pos mas 1
                                    listo
                                listo
                            listo
                            ; mov [rbp+off], rax
                            code[pos] es 0x48
                            pos es pos mas 1
                            code[pos] es 0x89
                            pos es pos mas 1
                            code[pos] es 0x45
                            pos es pos mas 1
                            code[pos] es off mas 256
                            pos es pos mas 1
                        sino
                            c es n2
                        listo
                    listo
                listo
            sino
                c es leer_byte()
            listo
        listo
    listo

    ; Backpatch jmp to principal
    numero jmp_off
    jmp_off es principal_pos menos jmp_patch_pos menos 4
    code[jmp_patch_pos] es jmp_off menos ((jmp_off entre 256) por 256)
    code[jmp_patch_pos mas 1] es (jmp_off entre 256) menos (((jmp_off entre 256) entre 256) por 256)
    code[jmp_patch_pos mas 2] es (jmp_off entre 65536) menos (((jmp_off entre 65536) entre 256) por 256)
    code[jmp_patch_pos mas 3] es jmp_off entre 16777216

    ; Flush buffer
    i es 0
    mientras i es_menor pos haga
        d es escribir_byte(code[i])
        i es i mas 1
    listo

    devuelvase 0
fin parcero
